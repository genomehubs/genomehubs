## Build stage
FROM node:24-bookworm AS builder
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm ci --production=false
COPY . .
## Generate static operation handlers into src/generated (bundled import) and bundle the app
RUN node scripts/generate-operation-handlers.cjs src/generated && \
    npm run build:bundle
## Prepare logs directory in builder so it can be copied into distroless runtime
RUN mkdir -p /app/logs \
    && chown -R node:node /app/logs \
    && chmod -R 0755 /app/logs
## Final runtime stage
FROM gcr.io/distroless/nodejs24-debian12
WORKDIR /app
COPY --from=builder /app/build ./build
COPY --from=builder /app/package.json ./package.json
## Copy pre-created logs directory (permissions preserved)
COPY --from=builder --chown=nonroot:nonroot /app/logs /app/logs
## Do NOT copy node_modules into the final image â€” use the bundled CommonJS file
## produced by the build step (`build/bundle.cjs`). This keeps the runtime image small.
EXPOSE 3000
ENV NODE_ENV=production
# Note: HEALTHCHECK not supported in distroless (no shell). Use external monitoring or k8s probes.
# Run the CommonJS bundle generated by the build script. Using `build/bundle.cjs`
# avoids ESM __dirname issues introduced by the ncc-produced ESM `dist/index.js`.
CMD ["--no-deprecation", "build/bundle.cjs"]
