#!/usr/bin/env node

const fs = require("fs");
const path = require("path");

const SRC_DIR = path.resolve(__dirname, "..", "src");
const OUT_FILE = path.join(SRC_DIR, "all_routes.js");

function collectFiles(dir) {
  const files = [];
  const entries = fs.readdirSync(dir, { withFileTypes: true });
  for (const ent of entries) {
    const full = path.join(dir, ent.name);
    if (ent.isDirectory()) {
      files.push(...collectFiles(full));
    } else if (ent.isFile() && ent.name.endsWith(".js")) {
      files.push(full);
    }
  }
  return files;
}

function toImportPath(absPath) {
  // We want imports relative to SRC_DIR, and starting with ./
  const rel = path.relative(SRC_DIR, absPath).split(path.sep).join("/");
  return `./${rel}`;
}

function main() {
  const routesDir = path.join(SRC_DIR, "api", "v2", "routes");
  const reportsDir = path.join(SRC_DIR, "api", "v2", "reports");
  const collected = [];
  if (fs.existsSync(routesDir)) collected.push(...collectFiles(routesDir));
  if (fs.existsSync(reportsDir)) collected.push(...collectFiles(reportsDir));

  const imports = collected
    .map((p) => toImportPath(p))
    // dedupe and sort
    .filter((v, i, a) => a.indexOf(v) === i)
    .sort()
    .map((p) => `import '${p}';`)
    .join("\n");

  // Also import common d3 UMD builds directly so bundlers include them instead of
  // leaving references to ESM source files that pkg might attempt to load at runtime.
  const d3DistImports = [];
  const d3Packages = ["d3-format", "d3-scale", "d3-interpolate", "d3-color"];
  for (const pkg of d3Packages) {
    const distPath = path
      .relative(
        SRC_DIR,
        path.join(__dirname, "..", "node_modules", pkg, "dist", `${pkg}.js`)
      )
      .split(path.sep)
      .join("/");
    const fullDist = path.join(
      __dirname,
      "..",
      "node_modules",
      pkg,
      "dist",
      `${pkg}.js`
    );
    if (fs.existsSync(fullDist)) {
      // create a relative import from SRC_DIR
      d3DistImports.push(`import './${distPath}';`);
    }
  }

  const content = `// Generated by scripts/generate-all-routes.cjs - imports all route and report modules so bundlers include them\n${imports}\n${d3DistImports.join(
    "\n"
  )}\n`;
  fs.writeFileSync(OUT_FILE, content, "utf8");
  console.log("Wrote", OUT_FILE, "with", collected.length, "imports");
}

main();
