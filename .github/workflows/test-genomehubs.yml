name: test-genomehubs

on: [push]

jobs:
  package-ui:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: "16"
      - run: npm install -g pkg
      - run: ./package-ui.sh
      - uses: actions/upload-artifact@v2
        with:
          path: ./dist/*

  package-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: "16"
      - run: npm install -g pkg
      - run: ./package-api.sh
      - uses: actions/upload-artifact@v2
        with:
          path: ./dist/*

  package-genomehubs-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install setuptools wheel twine
      - name: Build and publish
        run: |
          ./pip_install_latest.sh manylinux2014_x86_64
      - uses: actions/upload-artifact@v2
        with:
          path: ./dist/*

  run-test-fill:
    runs-on: ubuntu-latest
    needs:
      - package-api
      - package-ui
      - package-genomehubs-linux
    services:
      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch-oss:7.10.2
        options: -v es-data:/usr/share/elasticsearch/data
        ports:
          - 9200:9200
        env:
          discovery.type: single-node
    steps:
      - uses: actions/checkout@v2
      - name: Check health
        run: |
          curl -s "http://localhost:9200/_cat/health" ||
          sleep 15 && curl -s "http://localhost:9200/_cat/health"
      - name: Collect artifacts
        uses: actions/download-artifact@v2
        with:
          path: ./dist
      - name: Pip install genomehubs
        run: |
          python3 -m pip install --upgrade pip
          pip install dist/artifact/*linux*.whl
          genomehubs -v
      - name: Run genomehubs init
        run: |
          curl -X DELETE "http://localhost:9200/*--test_instance--*"
          genomehubs init \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --taxonomy-root 2759 \
              --taxonomy-jsonl tests/integration_tests/ena-taxonomy.extra.jsonl \
              --taxon-preload
      - name: Run genomehubs index
        run: |
          genomehubs index \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --assembly-dir tests/integration_tests/data/assembly-data
          genomehubs index \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --taxon-dir tests/integration_tests/data/lineages
          genomehubs index \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --taxon-dir tests/integration_tests/data/ott3.3
          genomehubs index \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --taxon-dir tests/integration_tests/data/tolids \
              --taxon-lookup any \
              --taxon-spellcheck
          genomehubs index \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --taxon-dir tests/integration_tests/data/genomesize_karyotype \
              --taxon-lookup any \
              --taxon-spellcheck
          genomehubs index \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --taxon-dir tests/integration_tests/data/regional_lists \
              --taxon-lookup any \
              --taxon-spellcheck
          genomehubs index \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --taxon-dir tests/integration_tests/data/uk_legislation \
              --taxon-lookup any \
              --taxon-spellcheck
          genomehubs index \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --assembly-dir tests/integration_tests/data/btk
          genomehubs index \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --taxon-dir tests/integration_tests/data/status_lists \
              --taxon-lookup any \
              --taxon-spellcheck
          genomehubs index \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --taxon-dir tests/integration_tests/data/assembly-data-taxon
      - name: Run genomehubs fill
        run: |
          genomehubs fill \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --traverse-root 2759 \
              --traverse-infer-both
          curl localhost:9200/_refresh
      - name: Index BTK files
        run: |
          genomehubs index \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --file-metadata tests/integration_tests/data/btk/btk.files.yaml
      - name: Check indices
        run: |
          curl -s "http://localhost:9200/_cat/indices"
      - name: Install UI test dependencies
        run: |
          sudo apt-get install -y chromium-browser
          pip install -r tests/integration_tests/ui/requirements.txt
      - name: Start API
        run: |
          chmod 755 dist/artifact/genomehubs-api-linux
          GH_RELEASE=2022.02.23 GH_HUBNAME=test_instance ./dist/artifact/genomehubs-api-linux &
          sleep 5
          chmod 755 dist/artifact/genomehubs-ui-linux
          GH_SITENAME=test_instance GH_API_URL=http://localhost:3000/api/v2 ./dist/artifact/genomehubs-ui-linux &
          sleep 5
          genomehubs test \
              --base-url http://localhost:3000/api/v2 \
              --json-test-dir tests/integration_tests/templates/api/json
          python run_ui_tests.py
      # - name: Run API tests
      #   run: |
      #     genomehubs test \
      #         --base-url http://localhost:3000/api/v2 \
      #         --json-test-dir tests/integration_tests/templates/api/json
      - run: netstat -tulpen
      # - name: Start UI
      #   run: |
      #     chmod 755 dist/artifact/genomehubs-ui-linux
      #     GH_SITENAME=test_instance GH_API_URL=http://localhost:3000/api/v2 ./dist/artifact/genomehubs-ui-linux &
      #     sleep 5
      # - name: Run UI tests
      #   run: |
      #     python run_ui_tests.py
