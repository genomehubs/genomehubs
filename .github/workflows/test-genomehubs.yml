name: test-genomehubs

on: [push]

jobs:
  # package-ui:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v2
  #     - uses: actions/setup-node@v2
  #       with:
  #         node-version: "16"
  #     - run: npm install -g pkg
  #     - run: ./package-ui.sh
  #     - uses: actions/upload-artifact@v2
  #       with:
  #         path: ./dist/*

  package-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: "16"
      - run: npm install -g pkg
      - run: ./package-api.sh
      - uses: actions/upload-artifact@v2
        with:
          path: ./dist/*

  package-genomehubs-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install setuptools wheel twine
      - name: Build and publish
        run: |
          ./pip_install_latest.sh manylinux2014_x86_64
      - uses: actions/upload-artifact@v2
        with:
          path: ./dist/*

  run-test-fill:
    runs-on: ubuntu-latest
    needs:
      - package-api
      - package-genomehubs-linux
    services:
      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch-oss:7.10.2
        ports:
          - 9200:9200
        env:
          discovery.type: single-node
    steps:
      - uses: actions/checkout@v2
      - name: Check health
        run: |
          curl -s "http://localhost:9200/_cat/health" ||
          sleep 15 && curl -s "http://localhost:9200/_cat/health"
      - name: Collect artifacts
        uses: actions/download-artifact@v2
        with:
          path: ./dist
      - name: Pip install genomehubs
        run: |
          python3 -m pip install --upgrade pip
          pip install dist/artifact/*linux*.whl
          genomehubs -v
      - name: Run genomehubs init
        run: |
          curl -X DELETE "http://localhost:9200/*--test_hub--*"
          genomehubs init \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --taxonomy-root 2759 \
              --taxonomy-jsonl tests/integration_tests/ena-taxonomy.extra.jsonl \
              --taxon-preload
          curl localhost:9200/refresh
      - name: Run genomehubs index
        run: |
          genomehubs index \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --assembly-dir tests/integration_tests/data/assembly-data
          curl localhost:9200/refresh
          genomehubs index \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --taxon-dir tests/integration_tests/data/ott3.3
          curl localhost:9200/refresh
          genomehubs index \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --taxon-dir tests/integration_tests/data/tolids \
              --taxon-lookup any \
              --taxon-spellcheck
          curl localhost:9200/refresh
          genomehubs index \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --taxon-dir tests/integration_tests/data/genomesize_karyotype \
              --taxon-lookup any \
              --taxon-spellcheck
          curl localhost:9200/refresh
          genomehubs index \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --taxon-dir tests/integration_tests/data/regional_lists \
              --taxon-lookup any \
              --taxon-spellcheck
          curl localhost:9200/refresh
          genomehubs index \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --taxon-dir tests/integration_tests/data/uk_legislation \
              --taxon-lookup any \
              --taxon-spellcheck
          curl localhost:9200/refresh
          genomehubs index \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --assembly-dir tests/integration_tests/data/btk
          curl localhost:9200/refresh
          genomehubs index \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --taxon-dir tests/integration_tests/data/status_lists \
              --taxon-lookup any \
              --taxon-spellcheck
          curl localhost:9200/_refresh
      - name: Run genomehubs fill
        run: |
          genomehubs fill \
              --config-file tests/integration_tests/config/config.yaml \
              --taxonomy-source ncbi \
              --traverse-root 2759 \
              --traverse-infer-both
          curl localhost:9200/_refresh
      # - name: Index BTK files
      #   run: |
      #     genomehubs index \
      #         --config-file tests/integration_tests/config/config.yaml \
      #         --taxonomy-source ncbi \
      #         --file-metadata tests/integration_tests/data/btk/btk.files.yaml
      - name: Check indices
        run: |
          curl -s "http://localhost:9200/_cat/indices"
      - name: Start API
        run: |
          chmod 755 dist/artifact/genomehubs-api-linux
          GH_RELEASE=2022.02.23 GH_HUBNAME=test_hub ./dist/artifact/genomehubs-api-linux &
          sleep 5
      - name: Run API tests
        run: |
          ./tests/integration_tests/scripts/test_api_responses.py \
              --json-test-dir tests/integration_tests/templates/api/json
