name: package-genomehubs
env:
  VERSION: 2.11.17

on:
  push:
    tags:
      - "*"

jobs:
  build-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: "24"
      - name: Generate handlers and build bundle
        working-directory: ./src/genomehubs-api
        run: |
          npm ci
          node scripts/generate-operation-handlers.cjs src/generated
          npm run build:bundle
      - uses: actions/upload-artifact@v4
        with:
          name: genomehubs-api-bundle
          path: ./src/genomehubs-api/build/*

  build-ui:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: "24"
      - name: Build UI assets
        working-directory: ./src/genomehubs-ui
        run: |
          npm ci
          npm run build
      - uses: actions/upload-artifact@v4
        with:
          name: genomehubs-ui-dist
          path: ./src/genomehubs-ui/dist/*

  package-genomehubs-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{github.ref}}
      - name: Pip install genomehubs
        run: |
          wget -O Miniforge3.sh "https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-$(uname)-$(uname -m).sh"
          bash Miniforge3.sh -b -p "${HOME}/conda"
          source "${HOME}/conda/etc/profile.d/conda.sh"
          source "${HOME}/conda/etc/profile.d/mamba.sh"
          conda create -n genomehubs python=3.11
          conda activate genomehubs
          conda install pip
          pip install --upgrade pip
          pip install setuptools wheel twine
          ./pip_install_latest.sh manylinux2014_x86_64
          genomehubs -v
      - uses: actions/upload-artifact@v4
        with:
          name: genomehubs-linux
          path: ./dist/*

  create-github-release:
    runs-on: ubuntu-latest
    needs:
      - build-api
      - build-ui
      - package-genomehubs-linux
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: ./tmp
      - run: |
          mkdir -p dist
          mv tmp/genomehubs-api-bundle/bundle.cjs dist/genomehubs-api-bundle.cjs || true
          mv tmp/genomehubs-ui-dist/* dist/
          mv tmp/genomehubs-linux/*gz dist/
          rm -rf tmp
          chmod 755 dist/genomehubs-*-linux || true
      - name: create release
        uses: "marvinpinto/action-automatic-releases@v1.2.1"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          draft: false
          prerelease: false
          title: "v${{github.ref_name}}"
          files: |
            dist/*

  upload-to-pypi:
    runs-on: ubuntu-latest
    needs:
      - create-github-release
    steps:
      - uses: actions/checkout@v3
      - uses: actions/download-artifact@v4
        with:
          name: genomehubs-linux
          path: ./dist
      - name: Publish package to PyPI
        uses: pypa/gh-action-pypi-publish@v1.5.0
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
          repository_url: https://upload.pypi.org/legacy/

  build-and-push-genomehubs-cli:
    runs-on: ubuntu-latest
    needs:
      - upload-to-pypi
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: genomehubs/genomehubs
      - uses: actions/download-artifact@v4
        with:
          name: genomehubs-linux
          path: ./dist
      - name: Prepare Docker context
        run: |
          mkdir -p src/docker/context
          mv dist/*manylinux2014_x86_64.whl src/docker/context/
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: src/docker/Dockerfile
          push: true
          build-args: |
            VERSION=${{ env.VERSION }}
          tags: |
            genomehubs/genomehubs:${{ env.VERSION }}
            genomehubs/genomehubs:latest
          labels: ${{ steps.meta.outputs.labels }}

  build-and-push-api:
    runs-on: ubuntu-latest
    needs:
      - upload-to-pypi
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: genomehubs/genomehubs-api
      - uses: actions/download-artifact@v4
        with:
          name: genomehubs-api-bundle
          path: ./src/genomehubs-api/build/
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: src/docker/api/Dockerfile
          push: true
          tags: |
            genomehubs/genomehubs-api:${{ env.VERSION }}
            genomehubs/genomehubs-api:latest
          labels: ${{ steps.meta.outputs.labels }}

  build-and-push-ui:
    runs-on: ubuntu-latest
    needs:
      - upload-to-pypi
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: genomehubs/genomehubs-ui
      - uses: actions/download-artifact@v4
        with:
          name: genomehubs-ui-dist
          path: ./src/genomehubs-ui/dist/
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: src/docker/ui/Dockerfile
          push: true
          tags: |
            genomehubs/genomehubs-ui:${{ env.VERSION }}
            genomehubs/genomehubs-ui:latest
          labels: ${{ steps.meta.outputs.labels }}
